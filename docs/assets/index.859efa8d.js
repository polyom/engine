var F=Object.defineProperty;var C=(r,t,e)=>t in r?F(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var l=(r,t,e)=>(C(r,typeof t!="symbol"?t+"":t,e),e);const J=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const h of i)if(h.type==="childList")for(const n of h.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const h={};return i.integrity&&(h.integrity=i.integrity),i.referrerpolicy&&(h.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?h.credentials="include":i.crossorigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function s(i){if(i.ep)return;i.ep=!0;const h=e(i);fetch(i.href,h)}};J();class O{constructor(t){l(this,"handlers",{});this.instance=t}on(t,e){var i;const s=(i=this.handlers[t])!=null?i:this.handlers[t]=[];if(!s.length){const h=this.instance[t].bind(this.instance);this.instance[t]=(...n)=>{const c=h(...n);for(const u of s)u(n,c);return c}}s.push(e.bind(this.instance))}off(t,e){var i;const s=(i=this.handlers[t])!=null?i:[];s.splice(s.indexOf(e),1)}}class E{constructor(t,e,s,i){this.a=t,this.b=e,this.c=s,this.d=i}number(){this.a>>>=0,this.b>>>=0,this.c>>>=0,this.d>>>=0;let t=this.a+this.b|0;return this.a=this.b^this.b>>>9,this.b=this.c+(this.c<<3)|0,this.c=this.c<<21|this.c>>>11,this.d=this.d+1|0,t=t+this.d|0,this.c=this.c+t|0,(t>>>0)/4294967296}shuffle(t){return[...t].sort(()=>this.number()-.5)}}function b(r,t,e,s){return e.every(([i,h])=>{const n=i+r,c=h+t;return n<0||n>=s[0].length?!1:c<0?!0:c<s.length&&s[c][n]<0})}function D(r,t){return(r%t+t)%t}class P{constructor(t,e,s,i,h,n=3,c=16){l(this,"x",0);l(this,"y",0);l(this,"angle",0);l(this,"current",-1);l(this,"held",-1);l(this,"board");l(this,"queue",[]);l(this,"canHold",!0);l(this,"stalls",0);this.width=t,this.height=e,this.pieces=s,this.spawns=i,this.random=h,this.minQueue=n,this.maxStalls=c,this.board=Array(e).fill(null).map(()=>Array(t).fill(-1))}isFloating(t=this.y+1){return b(this.x,t,this.getShape(),this.board)}getGhostY(){let t=this.y;for(;this.isFloating(t);)t++;return t-1}getPiece(t=this.current){return this.pieces[t]}getShape(t=this.current,e=this.angle){return this.getPiece(t).shapes[D(e,4)]}getKicks(t,e=this.current,s=this.angle){return this.getPiece(e).kicks[D(s,4)][t]}stall(){this.stalls++,this.stalls>=this.maxStalls&&!this.isFloating()&&(this.stalls=0,this.lock(),this.spawn())}rotate(t){return!!this.getKicks(t).find(([e,s])=>this.move(this.x+e,this.y-s,this.angle+(t==="left"?-1:1)))}shift(t,e){return this.move(this.x+t,this.y+e,this.angle)}slide(t){return this.shift(t,0)}print(t,e,s){return e<0?!1:(this.board[e][t]=s,!0)}lock(){this.canHold=!0;for(const[t,e]of this.getShape())this.print(this.x+t,this.y+e,this.current);return this.clear()}drop(){for(;this.shift(0,1););return this.lock()&&this.spawn()}swap(){const t=this.held;return this.held=this.current,t}hold(){if(!this.canHold)return!1;const t=this.swap();return this.canHold=!1,t<0?this.spawn():this.summon(t)}push(t){this.queue.push(t)}spawn(){for(;this.queue.length<=this.minQueue;)this.random.shuffle(this.pieces.keys()).forEach(t=>this.push(t));return this.summon(this.queue.shift())}summon(t){const[e,s]=this.getPiece(t).offset;return!!this.spawns.find(([i,h])=>this.set(i+e,h+s,0,t))}move(t,e,s){return this.set(t,e,s,this.current)}set(t,e,s,i){return b(t,e,this.getShape(i,s),this.board)?(this.x=t,this.y=e,this.angle=s,this.current=i,!0):!1}clear(){const t=[];for(let e=0;e<this.height;e++)this.board[e].every(s=>s>=0)&&(t.push(e),this.board.splice(e,1),this.board.unshift(new Array(this.width).fill(-1)));return t}}function Z({size:r,pieces:t,kicks:e={},spawns:s}){const i=t.map(({shape:h,kicks:n,offset:c=[0,0]})=>({offset:c,kicks:typeof n=="string"?e[n]:n,shapes:[0,0,0,0].map(()=>{const u=[];return h.forEach((x,S)=>x.forEach((y,q)=>y&&u.push([q,S]))),h=h[0].map((x,S)=>h.map(y=>y[S]).reverse()),u}),size:[h[0].length,h.length]}));return[r[0],r[1],i,s]}class z{constructor(t,e){l(this,"dx",0);l(this,"arrTimer",null);l(this,"slideLeft",!1);l(this,"slideRight",!1);l(this,"softDrop",!1);l(this,"rotateLeft",!1);l(this,"rotateRight",!1);l(this,"hold",!1);l(this,"hardDrop",!1);this.engine=t,this.handling=e}startHold(){this.hold||(this.hold=!0,this.engine.state.hold())}stopHold(){this.hold=!1}startHardDrop(){this.hardDrop||(this.hardDrop=!0,this.engine.state.drop())}stopHardDrop(){this.hardDrop=!1}startSlide(t=this.handling.das,e=this.dx){!(this.slideLeft||this.slideRight)||(this.handling.crt&&e!==this.dx?(clearTimeout(this.arrTimer),this.arrTimer=null,t=this.handling.das,e=this.dx):this.engine.state.slide(this.dx),this.arrTimer||(this.arrTimer=setTimeout(()=>{this.arrTimer=null,this.startSlide(this.handling.arr,e)},t)))}stopSlide(){this.dx=+this.slideRight-+this.slideLeft,!(this.slideLeft||this.slideRight)&&(clearTimeout(this.arrTimer),this.arrTimer=null)}startSlideLeft(){this.slideLeft||(this.slideLeft=!0,this.dx=-1,this.startSlide())}startSlideRight(){this.slideRight||(this.slideRight=!0,this.dx=1,this.startSlide())}stopSlideLeft(){this.slideLeft=!1,this.stopSlide()}stopSlideRight(){this.slideRight=!1,this.stopSlide()}startRotateLeft(){this.rotateLeft||(this.rotateLeft=!0,this.engine.state.rotate("left"))}startRotateRight(){this.rotateRight||(this.rotateRight=!0,this.engine.state.rotate("right"))}stopRotateLeft(){this.rotateLeft=!1}stopRotateRight(){this.rotateRight=!1}startSoftDrop(){this.softDrop||(this.softDrop=!0,this.engine.start(!0,this.engine.fall/this.handling.sdf))}stopSoftDrop(){this.softDrop=!1,this.engine.start(!1)}}class I extends O{constructor(t,e=1e3,s=500){super(t);l(this,"tickTimer",null);l(this,"lockTimer",null);this.state=t,this.fall=e,this.lockDelay=s;let i=!0,h=!0;this.on("hold",()=>{this.clearLockTimer()}),this.on("lock",()=>{this.clearLockTimer(),this.state.clear()}),this.on("set",()=>{h=i,i=this.state.isFloating()}),this.on("drop",()=>{this.start()});const n=(c,u)=>{u&&!h&&(this.lockTimer&&this.clearLockTimer(),this.state.stall())};this.on("slide",n),this.on("rotate",n)}clearLockTimer(){clearTimeout(this.lockTimer),this.lockTimer=null}tick(t=!1,e=this.fall){this.tickTimer=setTimeout(()=>this.tick(!0,e),e),!!t&&(!this.state.isFloating()&&!this.lockTimer?this.lockTimer=setTimeout(()=>{this.state.lock(),this.state.spawn()},this.lockDelay):this.state.shift(0,1))}start(t=!1,e=this.fall){this.stop(),this.tick(t,e)}stop(){clearTimeout(this.tickTimer)}}const K={size:[10,20],spawns:[[3,0],[3,-1],[3,-2]],kicks:{I:[{left:[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],right:[[0,0],[-2,0],[1,0],[-2,-1],[1,2]]},{left:[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],right:[[0,0],[-1,0],[2,0],[-1,2],[2,-1]]},{left:[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],right:[[0,0],[2,0],[-1,0],[2,1],[-1,-2]]},{left:[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],right:[[0,0],[1,0],[-2,0],[1,-2],[-2,1]]}],JLTSZ:[{left:[[0,0],[1,0],[1,1],[0,-2],[1,-2]],right:[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]]},{left:[[0,0],[1,0],[1,-1],[0,2],[1,2]],right:[[0,0],[1,0],[1,-1],[0,2],[1,2]]},{left:[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],right:[[0,0],[1,0],[1,1],[0,-2],[1,-2]]},{left:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],right:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]]}],O:[{left:[[0,0]],right:[[0,0]]},{left:[[0,0]],right:[[0,0]]},{left:[[0,0]],right:[[0,0]]},{left:[[0,0]],right:[[0,0]]}]},pieces:[{shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],kicks:"I"},{shape:[[1,0,0],[1,1,1],[0,0,0]],kicks:"JLTSZ"},{shape:[[0,0,1],[1,1,1],[0,0,0]],kicks:"JLTSZ"},{offset:[1,0],shape:[[1,1],[1,1]],kicks:"O"},{shape:[[0,1,1],[1,1,0],[0,0,0]],kicks:"JLTSZ"},{shape:[[0,1,0],[1,1,1],[0,0,0]],kicks:"JLTSZ"},{shape:[[1,1,0],[0,1,1],[0,0,0]],kicks:"JLTSZ"}]},o=new P(...Z(K),new E(1,2,3,4)),{width:A,height:v}=o,w=new I(o),a=25,[g,p,m]=document.querySelectorAll("canvas");p.width=A*a;p.height=v*a;g.width=g.height=4*a;m.width=4*a;m.height=3*4*a;const L=g.getContext("2d"),d=p.getContext("2d"),R=m.getContext("2d");w.fall=1e3;window.engine=w;o.spawn();w.start();const f=new z(w,{das:150,arr:50,dcd:6,crt:!0,sdf:10});window.onkeydown=({key:r})=>{switch(r){case"ArrowLeft":return f.startSlideLeft();case"ArrowRight":return f.startSlideRight();case"c":return f.startHold();case" ":return f.startHardDrop();case"z":return f.startRotateLeft();case"ArrowUp":case"x":return f.startRotateRight();case"ArrowDown":return f.startSoftDrop();default:console.log(r)}};window.onkeyup=({key:r})=>{switch(r){case"ArrowLeft":return f.stopSlideLeft();case"ArrowRight":return f.stopSlideRight();case"ArrowDown":return f.stopSoftDrop();case"z":return f.stopRotateLeft();case"ArrowUp":case"x":return f.stopRotateRight();case"c":return f.stopHold();case" ":return f.stopHardDrop()}};function T(r){return`hsl(${r/o.pieces.length*360}, 100%, 85%)`}function k(r,t,e,s,i,h=!1){const n=o.getShape(s,i);if(h){r.strokeStyle=T(s);for(let[c,u]of n)r.strokeRect((c+t)*a,(u+e)*a,a,a)}else{r.fillStyle=T(s);for(let[c,u]of n)r.fillRect((c+t)*a,(u+e)*a,a,a)}}function H(){L.fillStyle="#000",d.fillStyle="#000",R.fillStyle="#000",L.fillRect(0,0,g.width,g.height),d.fillRect(0,0,p.width,p.height),R.fillRect(0,0,m.width,m.height);for(let r=0;r<v;r++)for(let t=0;t<A;t++){const e=o.board[r][t];e>=0&&(d.fillStyle=T(e),d.fillRect(t*a,r*a,a,a))}k(d,o.x,o.getGhostY(),o.current,o.angle,!0),k(d,o.x,o.y,o.current,o.angle),o.queue.slice(0,3).forEach((r,t)=>{k(R,0,t*4,r,0)}),o.held>=0&&k(L,0,0,o.held,0),requestAnimationFrame(H)}H();
