var C=Object.defineProperty;var q=(r,t,e)=>t in r?C(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var h=(r,t,e)=>(q(r,typeof t!="symbol"?t+"":t,e),e);const O=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerpolicy&&(o.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?o.credentials="include":s.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}};O();function E([r,t,e,i]){return function(){r>>>=0,t>>>=0,e>>>=0,i>>>=0;let s=r+t|0;return r=t^t>>>9,t=e+(e<<3)|0,e=e<<21|e>>>11,i=i+1|0,s=s+i|0,e=e+s|0,(s>>>0)/4294967296}}class J{constructor(t,e,i,s,o){h(this,"x",0);h(this,"y",0);h(this,"i",-1);h(this,"d",0);h(this,"board");h(this,"bags",[]);h(this,"canHold",!0);h(this,"held",-1);h(this,"random");this.width=t,this.height=e,this.pieces=i,this.spawns=s,this.seed=o,this.random=E(o),this.board=new Array(e).fill(null).map(()=>new Array(t).fill(-1))}get queue(){return this.bags.flat()}get shape(){return this.pieces[this.i].shapes[this.d]}get ghostY(){let t=0;return this.try(()=>{for(;this.shift(0,1););t=this.y},!0),t}try(t,e=!1){const{x:i,y:s,d:o,i:a}=this;t(i,s,o,a);const c=this.valid();return(!c||e)&&this.set(i,s,o,a),c}get floating(){return this.try(()=>this.y++,!0)}shift(t,e){return this.trySet(this.x+t,this.y+e)}set(t=this.x,e=this.y,i=this.d,s=this.i){this.x=t,this.y=e,this.d=i,this.i=s}trySet(t=this.x,e=this.y,i=this.d,s=this.i){return this.try(()=>this.set(t,e,i,s))}rotate(t){const e=this.pieces[this.i].kicks[this.d];return!!(t<0?e.left:e.right).find(([i,s])=>this.trySet(this.x+i,this.y-s,(this.d+t+4)%4))}valid(){return this.shape.every(([t,e])=>{const i=t+this.x,s=e+this.y;return i>=0&&s>=0&&i<this.width&&s<this.height&&this.board[s][i]<0})}lock(){for(const[t,e]of this.shape)this.board[this.y+e][this.x+t]=this.i}drop(){for(;this.shift(0,1););this.lock(),this.spawn()}spawn(t=this.next()){return this.spawns.find(([e,i])=>this.trySet(e,i,0,t))}next(){for(this.canHold=!0;this.bags.length<4;)this.bags.push([...this.pieces.keys()].sort(()=>this.random()-.5));return this.bags[0].length===0&&this.bags.shift(),this.bags[0].shift()}hold(){if(!this.canHold)return!1;const t=this.held;this.held=this.i;const e=t<0?this.next():t;return this.canHold=!1,this.spawn(e)}clear(){const t=[];for(let e=0;e<this.height;e++)this.board[e].every(i=>i>=0)&&(t.push(e),this.board.splice(e,1),this.board.unshift(new Array(this.width).fill(-1)));return t}}class Z{constructor(t,e){h(this,"dx",0);h(this,"arrTimer",null);h(this,"slideLeft",!1);h(this,"slideRight",!1);h(this,"softDrop",!1);h(this,"rotateLeft",!1);h(this,"rotateRight",!1);h(this,"hold",!1);h(this,"hardDrop",!1);this.engine=t,this.handling=e}startHold(){if(!this.hold)return this.hold=!0,this.engine.hold()}stopHold(){this.hold=!1}startHardDrop(){if(!this.hardDrop)return this.hardDrop=!0,this.engine.drop()}stopHardDrop(){this.hardDrop=!1}startSlide(t=this.handling.das){!(this.slideLeft||this.slideRight)||(this.engine.shift(this.dx,0),this.arrTimer=setTimeout(()=>this.startSlide(this.handling.arr),t))}stopSlide(){this.dx=+this.slideRight-+this.slideLeft,!(this.slideLeft||this.slideRight)&&clearTimeout(this.arrTimer)}startSlideLeft(){this.slideLeft||(this.slideLeft=!0,this.dx=-1,this.startSlide())}startSlideRight(){this.slideRight||(this.slideRight=!0,this.dx=1,this.startSlide())}stopSlideLeft(){this.slideLeft=!1,this.stopSlide()}stopSlideRight(){this.slideRight=!1,this.stopSlide()}startRotateLeft(){if(!this.rotateLeft)return this.rotateLeft=!0,this.engine.rotate(-1)}startRotateRight(){if(!this.rotateRight)return this.rotateRight=!0,this.engine.rotate(1)}stopRotateLeft(){this.rotateLeft=!1}stopRotateRight(){this.rotateRight=!1}startSoftDrop(){this.softDrop||(this.softDrop=!0,this.engine.start(!0,this.engine.fall/this.handling.sdf))}stopSoftDrop(){this.softDrop=!1,this.engine.start(!1)}}class I extends J{constructor(){super(...arguments);h(this,"fall",1e3);h(this,"tickTimer",null);h(this,"lockTimer",null);h(this,"stalls",0);h(this,"maxStalls",3);h(this,"events",{hold:[],clear:[],shift:[],lock:[],rotate:[],tick:[]})}emit(t,...e){this.events[t].forEach(i=>i(...e))}on(t,e){this.events[t].push(e)}off(t,e){this.events[t].splice(this.events[t].indexOf(e),1)}lock(){super.lock(),this.clear(),this.emit("lock")}stall(){this.lockTimer&&(clearTimeout(this.lockTimer),this.lockTimer=null,this.stalls++,this.stalls>this.maxStalls&&!this.floating&&(this.stalls=0,this.lock(),this.spawn()))}shift(t,e){const i=super.shift(t,e);return this.emit("shift",t,e,i),i&&this.stall(),i}clear(){const t=super.clear();return this.emit("clear",t),t}rotate(t){const e=super.rotate(t);return this.emit("rotate",t,e),e&&this.stall(),e}tick(t=!1,e=this.fall){this.tickTimer=setTimeout(()=>this.tick(!0,e),e),!!t&&(!this.floating&&!this.lockTimer?this.lockTimer=setTimeout(()=>{this.lock(),this.spawn(),this.lockTimer=null},this.fall):this.shift(0,1),this.emit("tick"))}start(t=!1,e=this.fall){this.stop(),this.tick(t,e)}stop(){clearTimeout(this.tickTimer)}}function N({board:r,pieces:t,kickStore:e={},spawns:i},s){const o=t.map(({shape:a,kicks:c,offset:[D,A]=[0,0]})=>({kicks:typeof c=="string"?e[c]:c,shapes:[0,0,0,0].map(()=>{const L=[];return a.forEach((x,y)=>x.forEach((k,H)=>k&&L.push([H+D,y+A]))),a=a[0].map((x,y)=>a.map(k=>k[y]).reverse()),L})}));return[r[0],r[1],o,i,s]}const P=N({board:[10,20],spawns:[[3,0]],kickStore:{I:[{left:[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],right:[[0,0],[-2,0],[1,0],[-2,-1],[1,2]]},{left:[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],right:[[0,0],[-1,0],[2,0],[-1,2],[2,-1]]},{left:[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],right:[[0,0],[2,0],[-1,0],[2,1],[-1,-2]]},{left:[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],right:[[0,0],[1,0],[-2,0],[1,-2],[-2,1]]}],JLTSZ:[{left:[[0,0],[1,0],[1,1],[0,-2],[1,-2]],right:[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]]},{left:[[0,0],[1,0],[1,-1],[0,2],[1,2]],right:[[0,0],[1,0],[1,-1],[0,2],[1,2]]},{left:[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],right:[[0,0],[1,0],[1,1],[0,-2],[1,-2]]},{left:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],right:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]]}],O:[{left:[[0,0]],right:[[0,0]]},{left:[[0,0]],right:[[0,0]]},{left:[[0,0]],right:[[0,0]]},{left:[[0,0]],right:[[0,0]]}]},pieces:[{shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],kicks:"I"},{shape:[[1,0,0],[1,1,1],[0,0,0]],kicks:"JLTSZ"},{shape:[[0,0,1],[1,1,1],[0,0,0]],kicks:"JLTSZ"},{offset:[1,0],shape:[[1,1],[1,1]],kicks:"O"},{shape:[[0,1,1],[1,1,0],[0,0,0]],kicks:"JLTSZ"},{shape:[[0,1,0],[1,1,1],[0,0,0]],kicks:"JLTSZ"},{shape:[[1,1,0],[0,1,1],[0,0,0]],kicks:"JLTSZ"}]},[0,0,0,0]),l=new I(...P),{width:T,height:b}=l,n=25,[u,p,g]=document.querySelectorAll("canvas");p.width=T*n;p.height=b*n;u.width=u.height=4*n;g.width=4*n;g.height=3*4*n;const w=u.getContext("2d"),d=p.getContext("2d"),S=g.getContext("2d");l.fall=1e3;window.engine=l;l.spawn();l.start();const f=new Z(l,{das:150,arr:50,dcd:6,crt:!1,sdf:10});window.onkeydown=({key:r})=>{switch(r){case"ArrowLeft":return f.startSlideLeft();case"ArrowRight":return f.startSlideRight();case"c":return f.startHold();case" ":return f.startHardDrop();case"ArrowUp":case"z":return f.startRotateLeft();case"x":return f.startRotateRight();case"ArrowDown":return f.startSoftDrop();default:console.log(r)}};window.onkeyup=({key:r})=>{switch(r){case"ArrowLeft":return f.stopSlideLeft();case"ArrowRight":return f.stopSlideRight();case"ArrowDown":return f.stopSoftDrop();case"ArrowUp":case"z":return f.stopRotateLeft();case"x":return f.stopRotateRight();case"c":return f.stopHold();case" ":return f.stopHardDrop()}};function R(r){return`hsl(${r/l.pieces.length*360}, 100%, 75%)`}function m(r,t,e,i,s,o=!1){if(o){r.strokeStyle=R(i);for(let[a,c]of l.pieces[i].shapes[s])r.strokeRect((a+t)*n,(c+e)*n,n,n)}else{r.fillStyle=R(i);for(let[a,c]of l.pieces[i].shapes[s])r.fillRect((a+t)*n,(c+e)*n,n,n)}}function v(){w.fillStyle="#111",d.fillStyle="#111",S.fillStyle="#111",w.fillRect(0,0,u.width,u.height),d.fillRect(0,0,p.width,p.height),S.fillRect(0,0,g.width,g.height);for(let r=0;r<b;r++)for(let t=0;t<T;t++){const e=l.board[r][t];e>=0&&(d.fillStyle=R(e),d.fillRect(t*n,r*n,n,n))}m(d,l.x,l.ghostY,l.i,l.d,!0),m(d,l.x,l.y,l.i,l.d),l.queue.slice(0,3).forEach((r,t)=>{m(S,0,t*4,r,0)}),l.held>=0&&m(w,0,0,l.held,0),requestAnimationFrame(v)}v();
