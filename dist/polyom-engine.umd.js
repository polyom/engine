var R=Object.defineProperty;var b=(r,l,o)=>l in r?R(r,l,{enumerable:!0,configurable:!0,writable:!0,value:o}):r[l]=o;var e=(r,l,o)=>(b(r,typeof l!="symbol"?l+"":l,o),o);(function(r,l){typeof exports=="object"&&typeof module!="undefined"?l(exports):typeof define=="function"&&define.amd?define(["exports"],l):(r=typeof globalThis!="undefined"?globalThis:r||self,l(r.PolyomEngine={}))})(this,function(r){"use strict";function l([n,t,i,s]){return function(){n>>>=0,t>>>=0,i>>>=0,s>>>=0;let h=n+t|0;return n=t^t>>>9,t=i+(i<<3)|0,i=i<<21|i>>>11,s=s+1|0,h=h+s|0,i=i+h|0,(h>>>0)/4294967296}}class o{constructor(t,i,s,h,a){e(this,"x",0);e(this,"y",0);e(this,"i",-1);e(this,"d",0);e(this,"board");e(this,"bags",[]);e(this,"canHold",!0);e(this,"held",-1);e(this,"random");this.width=t,this.height=i,this.pieces=s,this.spawns=h,this.seed=a,this.random=l(a),this.board=new Array(i).fill(null).map(()=>new Array(t).fill(-1))}get queue(){return this.bags.flat()}get shape(){return this.pieces[this.i].shapes[this.d]}get ghostY(){let t=0;return this.try(()=>{for(;this.shift(0,1););t=this.y},!0),t}try(t,i=!1){const{x:s,y:h,d:a,i:f}=this;t(s,h,a,f);const d=this.valid();return(!d||i)&&this.set(s,h,a,f),d}get floating(){return this.try(()=>this.y++,!0)}shift(t,i){return this.trySet(this.x+t,this.y+i)}set(t=this.x,i=this.y,s=this.d,h=this.i){this.x=t,this.y=i,this.d=s,this.i=h}trySet(t=this.x,i=this.y,s=this.d,h=this.i){return this.try(()=>this.set(t,i,s,h))}rotate(t){const i=this.pieces[this.i].kicks[this.d];return!!(t<0?i.left:i.right).find(([s,h])=>this.trySet(this.x+s,this.y-h,(this.d+t+4)%4))}valid(){return this.shape.every(([t,i])=>{const s=t+this.x,h=i+this.y;return s>=0&&h>=0&&s<this.width&&h<this.height&&this.board[h][s]<0})}lock(){for(const[t,i]of this.shape)this.board[this.y+i][this.x+t]=this.i}drop(){for(;this.shift(0,1););this.lock(),this.spawn()}spawn(t=this.next()){return this.spawns.find(([i,s])=>this.trySet(i,s,0,t))}next(){for(this.canHold=!0;this.bags.length<4;)this.bags.push([...this.pieces.keys()].sort(()=>this.random()-.5));return this.bags[0].length===0&&this.bags.shift(),this.bags[0].shift()}hold(){if(!this.canHold)return!1;const t=this.held;this.held=this.i;const i=t<0?this.next():t;return this.canHold=!1,this.spawn(i)}clear(){const t=[];for(let i=0;i<this.height;i++)this.board[i].every(s=>s>=0)&&(t.push(i),this.board.splice(i,1),this.board.unshift(new Array(this.width).fill(-1)));return t}}class m{constructor(t,i){e(this,"dx",0);e(this,"arrTimer",null);e(this,"slideLeft",!1);e(this,"slideRight",!1);e(this,"softDrop",!1);e(this,"rotateLeft",!1);e(this,"rotateRight",!1);e(this,"hold",!1);e(this,"hardDrop",!1);this.engine=t,this.handling=i}startHold(){if(!this.hold)return this.hold=!0,this.engine.hold()}stopHold(){this.hold=!1}startHardDrop(){if(!this.hardDrop)return this.hardDrop=!0,this.engine.drop()}stopHardDrop(){this.hardDrop=!1}startSlide(t=this.handling.das){!(this.slideLeft||this.slideRight)||(this.engine.shift(this.dx,0),this.arrTimer=setTimeout(()=>this.startSlide(this.handling.arr),t))}stopSlide(){this.dx=+this.slideRight-+this.slideLeft,!(this.slideLeft||this.slideRight)&&clearTimeout(this.arrTimer)}startSlideLeft(){this.slideLeft||(this.slideLeft=!0,this.dx=-1,this.startSlide())}startSlideRight(){this.slideRight||(this.slideRight=!0,this.dx=1,this.startSlide())}stopSlideLeft(){this.slideLeft=!1,this.stopSlide()}stopSlideRight(){this.slideRight=!1,this.stopSlide()}startRotateLeft(){if(!this.rotateLeft)return this.rotateLeft=!0,this.engine.rotate(-1)}startRotateRight(){if(!this.rotateRight)return this.rotateRight=!0,this.engine.rotate(1)}stopRotateLeft(){this.rotateLeft=!1}stopRotateRight(){this.rotateRight=!1}startSoftDrop(){this.softDrop||(this.softDrop=!0,this.engine.start(!0,this.engine.fall/this.handling.sdf))}stopSoftDrop(){this.softDrop=!1,this.engine.start(!1)}}class y extends o{constructor(){super(...arguments);e(this,"fall",1e3);e(this,"tickTimer",null);e(this,"lockTimer",null);e(this,"stalls",0);e(this,"maxStalls",3);e(this,"events",{hold:[],clear:[],shift:[],lock:[],rotate:[],tick:[]})}emit(t,...i){this.events[t].forEach(s=>s(...i))}on(t,i){this.events[t].push(i)}off(t,i){this.events[t].splice(this.events[t].indexOf(i),1)}lock(){super.lock(),this.clear(),this.emit("lock")}stall(){this.lockTimer&&(clearTimeout(this.lockTimer),this.lockTimer=null,this.stalls++,this.stalls>this.maxStalls&&!this.floating&&(this.stalls=0,this.lock(),this.spawn()))}shift(t,i){const s=super.shift(t,i);return this.emit("shift",t,i,s),s&&this.stall(),s}clear(){const t=super.clear();return this.emit("clear",t),t}rotate(t){const i=super.rotate(t);return this.emit("rotate",t,i),i&&this.stall(),i}tick(t=!1,i=this.fall){this.tickTimer=setTimeout(()=>this.tick(!0,i),i),!!t&&(!this.floating&&!this.lockTimer?this.lockTimer=setTimeout(()=>{this.lock(),this.spawn(),this.lockTimer=null},this.fall):this.shift(0,1),this.emit("tick"))}start(t=!1,i=this.fall){this.stop(),this.tick(t,i)}stop(){clearTimeout(this.tickTimer)}}function k({board:n,pieces:t,kickStore:i={},spawns:s},h){const a=t.map(({shape:f,kicks:d,offset:[T,S]=[0,0]})=>({kicks:typeof d=="string"?i[d]:d,shapes:[0,0,0,0].map(()=>{const p=[];return f.forEach((g,u)=>g.forEach((c,x)=>c&&p.push([x+T,u+S]))),f=f[0].map((g,u)=>f.map(c=>c[u]).reverse()),p})}));return[n[0],n[1],a,s,h]}r.Controller=m,r.Engine=y,r.Machine=o,r.fromConfig=k,Object.defineProperty(r,"__esModule",{value:!0}),r[Symbol.toStringTag]="Module"});
