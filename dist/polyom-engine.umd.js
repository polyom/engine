var b=Object.defineProperty;var w=(r,a,f)=>a in r?b(r,a,{enumerable:!0,configurable:!0,writable:!0,value:f}):r[a]=f;var e=(r,a,f)=>(w(r,typeof a!="symbol"?a+"":a,f),f);(function(r,a){typeof exports=="object"&&typeof module!="undefined"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(r=typeof globalThis!="undefined"?globalThis:r||self,a(r.PolyomEngine={}))})(this,function(r){"use strict";class a{constructor(t){e(this,"handlers",{});this.instance=t}on(t,s){var h;const i=(h=this.handlers[t])!=null?h:this.handlers[t]=[];if(!i.length){const n=this.instance[t].bind(this.instance);this.instance[t]=(...l)=>{const u=n(...l);for(const c of i)c(l,u);return u}}i.push(s.bind(this.instance))}off(t,s){var h;const i=(h=this.handlers[t])!=null?h:[];i.splice(i.indexOf(s),1)}}class f{constructor(t,s,i,h){this.a=t,this.b=s,this.c=i,this.d=h}number(){this.a>>>=0,this.b>>>=0,this.c>>>=0,this.d>>>=0;let t=this.a+this.b|0;return this.a=this.b^this.b>>>9,this.b=this.c+(this.c<<3)|0,this.c=this.c<<21|this.c>>>11,this.d=this.d+1|0,t=t+this.d|0,this.c=this.c+t|0,(t>>>0)/4294967296}shuffle(t){return[...t].sort(()=>this.number()-.5)}}function p(o,t,s,i){return s.every(([h,n])=>{const l=h+o,u=n+t;return l<0||l>=i[0].length?!1:u<0?!0:u<i.length&&i[u][l]<0})}function m(o,t){return(o%t+t)%t}class k{constructor(t,s,i,h,n,l=3,u=16){e(this,"x",0);e(this,"y",0);e(this,"angle",0);e(this,"current",-1);e(this,"held",-1);e(this,"board");e(this,"queue",[]);e(this,"canHold",!0);e(this,"stalls",0);this.width=t,this.height=s,this.pieces=i,this.spawns=h,this.random=n,this.minQueue=l,this.maxStalls=u,this.board=Array(s).fill(null).map(()=>Array(t).fill(-1))}isFloating(t=this.y+1){return p(this.x,t,this.getShape(),this.board)}getGhostY(){let t=this.y;for(;this.isFloating(t);)t++;return t-1}getPiece(t=this.current){return this.pieces[t]}getShape(t=this.current,s=this.angle){return this.getPiece(t).shapes[m(s,4)]}getKicks(t,s=this.current,i=this.angle){return this.getPiece(s).kicks[m(i,4)][t]}stall(){this.stalls++,this.stalls>=this.maxStalls&&!this.isFloating()&&(this.stalls=0,this.lock(),this.spawn())}rotate(t){return!!this.getKicks(t).find(([s,i])=>this.move(this.x+s,this.y-i,this.angle+(t==="left"?-1:1)))}shift(t,s){return this.move(this.x+t,this.y+s,this.angle)}slide(t){return this.shift(t,0)}print(t,s,i){return s<0?!1:(this.board[s][t]=i,!0)}lock(){this.canHold=!0;for(const[t,s]of this.getShape())this.print(this.x+t,this.y+s,this.current);return this.clear()}drop(){for(;this.shift(0,1););return this.lock()&&this.spawn()}swap(){const t=this.held;return this.held=this.current,t}hold(){if(!this.canHold)return!1;const t=this.swap();return this.canHold=!1,t<0?this.spawn():this.summon(t)}push(t){this.queue.push(t)}spawn(){for(;this.queue.length<=this.minQueue;)this.random.shuffle(this.pieces.keys()).forEach(t=>this.push(t));return this.summon(this.queue.shift())}summon(t){const[s,i]=this.getPiece(t).offset;return!!this.spawns.find(([h,n])=>this.set(h+s,n+i,0,t))}move(t,s,i){return this.set(t,s,i,this.current)}set(t,s,i,h){return p(t,s,this.getShape(h,i),this.board)?(this.x=t,this.y=s,this.angle=i,this.current=h,!0):!1}clear(){const t=[];for(let s=0;s<this.height;s++)this.board[s].every(i=>i>=0)&&(t.push(s),this.board.splice(s,1),this.board.unshift(new Array(this.width).fill(-1)));return t}}function S({size:o,pieces:t,kicks:s={},spawns:i}){const h=t.map(({shape:n,kicks:l,offset:u=[0,0]})=>({offset:u,kicks:typeof l=="string"?s[l]:l,shapes:[0,0,0,0].map(()=>{const c=[];return n.forEach((T,d)=>T.forEach((g,R)=>g&&c.push([R,d]))),n=n[0].map((T,d)=>n.map(g=>g[d]).reverse()),c}),size:[n[0].length,n.length]}));return[o[0],o[1],h,i]}class y{constructor(t,s){e(this,"dx",0);e(this,"arrTimer",null);e(this,"slideLeft",!1);e(this,"slideRight",!1);e(this,"softDrop",!1);e(this,"rotateLeft",!1);e(this,"rotateRight",!1);e(this,"hold",!1);e(this,"hardDrop",!1);this.engine=t,this.handling=s}startHold(){this.hold||(this.hold=!0,this.engine.state.hold())}stopHold(){this.hold=!1}startHardDrop(){this.hardDrop||(this.hardDrop=!0,this.engine.state.drop())}stopHardDrop(){this.hardDrop=!1}startSlide(t=this.handling.das,s=this.dx){!(this.slideLeft||this.slideRight)||(this.handling.crt&&s!==this.dx?(clearTimeout(this.arrTimer),this.arrTimer=null,t=this.handling.das,s=this.dx):this.engine.state.slide(this.dx),this.arrTimer||(this.arrTimer=setTimeout(()=>{this.arrTimer=null,this.startSlide(this.handling.arr,s)},t)))}stopSlide(){this.dx=+this.slideRight-+this.slideLeft,!(this.slideLeft||this.slideRight)&&(clearTimeout(this.arrTimer),this.arrTimer=null)}startSlideLeft(){this.slideLeft||(this.slideLeft=!0,this.dx=-1,this.startSlide())}startSlideRight(){this.slideRight||(this.slideRight=!0,this.dx=1,this.startSlide())}stopSlideLeft(){this.slideLeft=!1,this.stopSlide()}stopSlideRight(){this.slideRight=!1,this.stopSlide()}startRotateLeft(){this.rotateLeft||(this.rotateLeft=!0,this.engine.state.rotate("left"))}startRotateRight(){this.rotateRight||(this.rotateRight=!0,this.engine.state.rotate("right"))}stopRotateLeft(){this.rotateLeft=!1}stopRotateRight(){this.rotateRight=!1}startSoftDrop(){this.softDrop||(this.softDrop=!0,this.engine.start(!0,this.engine.fall/this.handling.sdf))}stopSoftDrop(){this.softDrop=!1,this.engine.start(!1)}}class L extends a{constructor(t,s=1e3,i=500){super(t);e(this,"tickTimer",null);e(this,"lockTimer",null);this.state=t,this.fall=s,this.lockDelay=i;let h=!0,n=!0;this.on("hold",()=>{this.clearLockTimer()}),this.on("lock",()=>{this.clearLockTimer(),this.state.clear()}),this.on("set",()=>{n=h,h=this.state.isFloating()}),this.on("drop",()=>{this.start()});const l=(u,c)=>{c&&!n&&(this.lockTimer&&this.clearLockTimer(),this.state.stall())};this.on("slide",l),this.on("rotate",l)}clearLockTimer(){clearTimeout(this.lockTimer),this.lockTimer=null}tick(t=!1,s=this.fall){this.tickTimer=setTimeout(()=>this.tick(!0,s),s),!!t&&(!this.state.isFloating()&&!this.lockTimer?this.lockTimer=setTimeout(()=>{this.state.lock(),this.state.spawn()},this.lockDelay):this.state.shift(0,1))}start(t=!1,s=this.fall){this.stop(),this.tick(t,s)}stop(){clearTimeout(this.tickTimer)}}r.Controller=y,r.Engine=L,r.Listener=a,r.Random=f,r.State=k,r.paramsFromJson=S,Object.defineProperty(r,"__esModule",{value:!0}),r[Symbol.toStringTag]="Module"});
